---
title: http 缓存
date: 2017-09-22 11:14:27
tags: http 缓存
---

    整个Web系统架构在HTTP协议之上,合理利用好HTTP提供的缓存机制不仅可以极大的减少服务器负载,更重要的加速页面的载入,以及减少用户流量的消耗.
    快速到达和易于访问是Web与生俱来的特性,其缓存机制也早已被服务器和浏览器厂商广泛的实现了.这里我们从缓存的三个方面记录一下HTTP缓存的内容.
    
 ### HTTP 缓存体系
    首先我们将HTTP缓存体系分为三个部分,分别是  缓存存储策略 缓存过期策略 缓存对比策略(协商策略)
    
 ![Mou icon](/uploads/httpCache1.png)
    
    
 #### 缓存存储策略
    Cache-Control 用来确定HTTP响应内容是否可以被客户端缓存,以及被那些客户端缓存;Cache-Control的值有以下这些:
        * no-cache : 表示必须先与服务器确认返回的响应是否被更改,如果未更改则可以直接从缓存里获取,避免重复下载(ps:也就是内容会被缓存起来,但之后想用的时候必须先跟服务器确认内容是否被更改过了)
        * no-store :禁止缓存任何响应,也就是说每次用户请求资源时,都会向服务器发送一个请求,每次都会下载完整的响应
        * public : 大家都可以缓存,包括代理
        * private : 浏览器可以缓存private响应,但是通常只为单个用户缓存,因此不允许任何代理服务器对其进行缓存.比如用户浏览器可以缓存用户的私人信息的html网页,但cdn不能缓存.
        * max-age : 用来设置资源缓存的最长时间(单位是秒)
        
        通过Cache-Control:Public 设置缓存HTTP响应数据存储到本地,但此时并不意味着后续的请求会直接从缓存中读取数据并使用,这是为什么呢?因为它无法确定本地缓存的数据是否可用(有可能已经失效),还必须借助其它鉴别机制来确认才行,这就是我们下面要说的"缓存过期策略".
        
 #### 缓存过期策略
        客户端用来确定存储在本地的缓存数据是否已过期,进而觉得是否要发请求到服务器获取数据.不过期就读取本地缓存数据,过期的话就发请求到服务端获取;
        那么浏览器是通过什么参数来判断的呢?答案是:Expires,Expires指定了缓存数据有效的绝对时间,告诉客户端到了这个时间点(与客户端时间对比)后本地缓存就作废了,
        在这个时间点内客户端可以认为缓存数据有效,可直接从缓存中加载展示.
        
        不过HTTP缓存头设计并没有想象那么规矩,
        ```bash
        //比如
        Cache-Control:max-age
        //相当于=>
        Cache-Control:Public/Private
        Expires:当前客户端时间+maxage
        
        //而
        Cache-Control:no-Cache
        //等同于
        Cache-Control:max-age=0
        ```
        ps:
        1.Cache-Control中指定的缓存过期策略优先级高于Expires,当它们同时存在的时候,后者会被覆盖掉.
        2.缓存数据标记为已过期只是告诉客户端不能再直接从本地读取缓存了,需要再发一次请求到服务器去确认,并不等同于本地缓存数据从此没用了,有些情况即使过期了还是会被再次用到,具体下面会讲到.
        
        
 #### 缓存对比策略
        将缓存在客户端的数据标识发往服务端,服务端通过标识来判断客户端缓存数据是否有效,进而决定是否要重发数据.
        
        客户端检测到缓存数据过期或浏览器刷新后,往往会重新发起一个http请求到服务器,服务器此时并不急于返回数据,而是看请求头有没有带有标识(If-Modified-Since、If-None-Match)过来,如果判断标识仍然有效,则返回304告诉客户端读取本地缓存数据来用即可(这里要注意的是你必须要在首次响应时输出响应的头信息(Last-Modified、ETags)到客户端).至此我们就明白了上面所说的本地缓存数据即使被认为过期,并不等于数据从此就没用了的道理了.
        
        下面我将缓存策略三要素和常用的几个缓存头（项）结合一起，让大家更清晰的认识到它们之间的关系：
        
 ![Mou icon](/uploads/httpCache2.png)